<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Banana Eater</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
    
    const WIDTH = window.innerWidth,
          HEIGHT = window.innerHeight;

    var config = {
        type: Phaser.AUTO,
        width: WIDTH, 
        height: HEIGHT,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 300 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var player;
    var bananas;
	var bombs;
	var trophy;
    var platforms;
    
    var score = 100;
    var scoreText;
    var instructions;
    
    var keyboard;
	var playerStatus;
    var isRestarted = false;

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('ground', 'assets/platform.png');
        this.load.image('grenade', 'assets/grenade.png');
        this.load.image('banana', 'assets/banana.png');
		this.load.image('monkey', 'assets/monkey.png');
	    this.load.image('trophy', 'assets/trophy.png');
        this.load.spritesheet('dude', 'assets/sprite1.png', { frameWidth: 36, frameHeight: 34 });
        this.load.spritesheet('banana_eat', 'assets/bananasprite02.png', { frameWidth: 35, frameHeight: 33 });
        this.load.spritesheet('explosion', 'assets/explosion0.png', { frameWidth: 128, frameHeight: 128 });
    }
    
    function create ()
    {   
        ////key events
        keyboard = {
            SPACE : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
            A : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
            W : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
            D : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
            LEFT: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),
            UP: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
            RIGHT: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),
        }
        //player status
        playerStatus = {
            ALIVE: 'ALIVE',
            DETH: 'DETH',
            STARVATION: 'STARVATION',
            WIN: 'WIN',
            RESTARTING: 'RESTARTING',
            STATUS:  'ALIVE'
        }
        ///animation frames
		if(!isRestarted){
            for(let i = 0; i <= 10; i++){
                this.anims.create({
                    key: 'mokey'+ i,
                    frames: [ { key: 'dude', frame: i } ],
                    frameRate: 20
                });
            }

            this.anims.create({
                    key: 'boom',
                    frames: this.anims.generateFrameNumbers('explosion', { start: 0, end:  5}),
                    frameRate: 40,
                    repeat : 0
            });
            this.anims.create({
                    key: 'eat',
                    frames: this.anims.generateFrameNumbers('banana_eat', { start: 0, end:  5}),
                    frameRate: 40,
                    repeat : 0
            });
        }
       
        ///platforms, trophys, bananas and bombs
		platforms = this.physics.add.staticGroup();
		bananas = this.physics.add.group();
		bombs = this.physics.add.group();
		trophy = this.physics.add.group();
		platforms.create(300, 568, 'ground').setScale(1.5).refreshBody();
        
		let step = 0;
		let length = 100;
		for(let i = 0; i < length; i++){
			let scale = Phaser.Math.Between(50, 90)/100;
			let x = Phaser.Math.Between(-50, 750);
			let y = 400 + step*(-130)+(Phaser.Math.Between(-40, 40));
			var platform = platforms.create(x, y, 'ground').setScale(scale).refreshBody();
			platform.body.checkCollision.down = false;
	        platform.body.checkCollision.left = false;
	        platform.body.checkCollision.right = false;
            //////create trophy in every (100/3)*x% length of map 
			if(i == Math.round(length/3) || i == Math.round((length/3)*2) || i == length-1){
				trophy.create(platform.x, platform.y - 50, 'trophy');
                step++;
				continue;
			}
            //////create banana with chance 60%
			if(Phaser.Math.Between(0, 100) < 60){
                createBanana(1);
			}
            //////create bomb with chance 50%
            if(Phaser.Math.Between(0, 100) < 50){
                createBomb(1);
			}
			function createBanana(number){
				if(number==3){
                   return 0;
                }
				bananas.create(Phaser.Math.Between(x - (platform.width*scale)/2 + 18, x + (platform.width*scale)/2 - 18), (y - 18-number*30), 'banana');
				if(Phaser.Math.Between(0, Math.round(100*(number*0.6))) < 20){
					createBanana(++number);
				}
			}
            function createBomb(number){
				if(number==3){
                   return 0;
                }
				bombs.create(Phaser.Math.Between(x - (platform.width*scale)/2 + 20, x + (platform.width*scale)/2 - 20), (y - 18-number*30), 'grenade');
				if(Phaser.Math.Between(0, Math.round(100*(number*0.6))) < 25){
					createBanana(++number);
				}
			}
			step++;
		}
        bananas.children.iterate((child)=>{child.setBounceY(Phaser.Math.FloatBetween(0.2, 0.5));});
        bombs.children.iterate((child)=>{child.setBounceY(Phaser.Math.FloatBetween(0.2, 0.7));});
        
        ////player
        player = this.physics.add.sprite(300, 450, 'monkey');
		player.setBounceX(0.2);
        player.setBounceY(0.2);
        player.setCollideWorldBounds(true);
        player.body.setGravityY(1000);
        player.body.collideWorldBounds = false;
        

        ////Scores
        scoreText = this.add.text(16, 16, 'Height: 0\nFood: 0', { fontSize: '32px', fill: '#eee' });
        if(!isRestarted){
            instructions = this.add.text(-50, 600, 
                '\nUp arrow or W button - simple jump(cost: 3 points of food)\n'+
                'Left, Right arrows or A, D buttons - move to left or right(cost: 0)\n'+
                'Space button - boosted jump(cost: 25 points of food)\n'+
                'Cathing banana: +10 points of food, cathing bomb: -15 points of food\n'+
                'If food points are zero - you dead. If you find a trophy - you win',
                { fontSize: '18px', fill: '#eee' });
            }
        
        ///camera
		this.cameras.main.startFollow(player);
        
        ////colliders
        this.physics.add.collider(platforms, player);
		this.physics.add.collider(bananas, platforms);
		this.physics.add.collider(bombs, platforms);
        this.physics.add.collider(trophy, platforms);
        this.physics.add.collider(bombs, bananas);
		this.physics.add.collider(bananas, bananas);
		this.physics.add.collider(bombs, bombs);
		
        
        ///overlaps
        this.physics.add.overlap(player, bananas, (player, banana)=>{
            var eat = this.physics.add.sprite(banana.x, banana.y, 'banana_eat');
            eat.anims.play('eat');
            eat.body.setGravity(0);
            setTimeout(()=>{eat.destroy();}, 260);
            collectbanana(player, banana);
        }, null, this);
		this.physics.add.overlap(player, bombs, (player, bomb)=>{
            var boom = this.physics.add.sprite(bomb.x, bomb.y, 'explosion');
            boom.anims.play('boom');
            boom.body.setGravity(0);
            setTimeout(()=>{boom.destroy();}, 260);
            collectBomb(player, bomb);
        }, null, this);
		this.physics.add.overlap(player, trophy, collectTrophy, null, this);
    }

    function update ()
    {   
        //alive test;
        if(playerStatus.STATUS == playerStatus.ALIVE && score < -100){
           playerStatus.STATUS = playerStatus.WIN;
        }
        else if(playerStatus.STATUS == playerStatus.ALIVE && player.y - 800 > 0){
           playerStatus.STATUS = playerStatus.DETH;
        }
        else if(playerStatus.STATUS == playerStatus.ALIVE && score < 0){
            playerStatus.STATUS = playerStatus.STARVATION;
        }
        
        //monkey control
		if(playerStatus.STATUS == playerStatus.ALIVE){
        ///moving
	        let acsekleration = 1000;
	        let maxSpeed = 500;
	        if( keyboard.LEFT.isDown || keyboard.A.isDown) {
	            player.body.setGravityX(-acsekleration);
	        } else if( keyboard.RIGHT.isDown  || keyboard.D.isDown) {
	            player.body.setGravityX(acsekleration);
	        } else {
				if(Math.abs(player.body.velocity.x) < 0.01){
					player.body.velocity.x = 0;
				}
	            if(player.body.velocity.x == 0){
	                player.body.setGravityX(0);
	            }else if(player.body.velocity.x > 0){
	                player.body.setGravityX(-acsekleration);
	            }else{
	                player.body.setGravityX(acsekleration);
	            }
	        }
	        if(Math.abs(player.body.velocity.x) > maxSpeed){
	           player.body.velocity.x = maxSpeed * Math.sign(player.body.velocity.x);
	        }
	        //jumping
	        if (player.body.touching.down && (keyboard.UP.isDown || keyboard.W.isDown))
	        {
	            player.setVelocityY(-730);
				score -= 3;
	        }else if(keyboard.SPACE.isDown && player.body.touching.down){
				if(score>=25){
					player.setVelocityY(-730*1.8);
					score -= 25;
				}else{
					player.setVelocityY(-730);
					score -= 3;
				}
			}
            if(keyboard.LEFT.isDown || keyboard.RIGHT.isDown || keyboard.A.isDown || keyboard.D.isDown) {
	            instructions.setText('');
	        } 
		}
        
        //fat monkey test
        if(playerStatus.STATUS == playerStatus.ALIVE){
          if(score < 10){
                    player.anims.play('mokey0');   
                }else if(score<20){
                    player.anims.play('mokey1');
                }else if(score<40){
                    player.anims.play('mokey2');
                }else if(score<70){
                    player.anims.play('mokey3');
                }else if(score<120){
                    player.anims.play('mokey4');
                }else if(score<140){
                    player.anims.play('mokey5');
                }else if(score<150){
                    player.anims.play('mokey6');
                }else if(score<160){
                    player.anims.play('mokey7');
                }else if(score<170){
                    player.anims.play('mokey8');
                }else if(score<190){
                    player.anims.play('mokey9');
                }else{
                    player.anims.play('mokey10');
                }
        }
                
        
		///Print scores
        if(playerStatus.STATUS == playerStatus.ALIVE){
			let food = 'Food: ' + score;
			let height = 'Height: '+(Math.abs((player.y - 400)/130) + '').split('.')[0];
            scoreText.setText(height + '\n' + food);
            scoreText.x = player.x - WIDTH/2 + 30;
            scoreText.y = player.y - HEIGHT/2  + 30;
        }
        else if(playerStatus.STATUS == playerStatus.DETH){
            scoreText.setText('Monkey dead!\n\n');
        }
        else if(playerStatus.STATUS == playerStatus.WIN){
            scoreText.setText('You Win!\n\n');
        }
        else if(playerStatus.STATUS == playerStatus.STARVATION){
            scoreText.setText('Food is over!\n\n');
        }
        else if(playerStatus.STATUS == playerStatus.RESTARTING){
            scoreText.x = player.x - scoreText.width/2;
            scoreText.y = player.y - player.width*5;
            player.setVelocityY(50);
        }
        

		
        if(playerStatus.STATUS != playerStatus.ALIVE && playerStatus.STATUS != playerStatus.RESTARTING){
            gameOverAnimation();
            playerStatus.STATUS = playerStatus.RESTARTING;
            setTimeout(()=>{
                score = 100;
                playerStatus.STATUS == playerStatus.ALIVE;
                isRestarted = true;
                this.scene.restart();
            }, 2000);
        }

		function gameOverAnimation(){
			platforms.children.iterate(function (platform) {
	            platform.disableBody(true, true);
	        });
			bananas.children.iterate(function (banana) {
	            banana.setVelocityY(250);
				banana.body.setGravityY(0);
	        });
			bombs.children.iterate(function (bomb) {
				bomb.setVelocityY(450);
				bomb.body.setGravityY(0);
	        });
            trophy.children.iterate(function (bomb) {
				bomb.setVelocityY(200);
				bomb.body.setGravityY(0);
	        });
			player.body.setGravityY(0);
			player.body.setGravityX(0);
			player.setVelocityY(0);
			player.setVelocityX(0);
		}
    }

    function collectbanana (player, banana){
        banana.destroy();
        if(playerStatus.STATUS == playerStatus.ALIVE){
            score += 10;
        }
    }

	function collectBomb (player, bomb){
        bomb.destroy();
        if(playerStatus.STATUS == playerStatus.ALIVE){
            score -= 15;
        }
    }

	function collectTrophy (player, trophy){
        trophy.disableBody(true, true);
        if(playerStatus.STATUS == playerStatus.ALIVE){
           score = -1000;
        }
    }

    
</script>

</body>
</html>
