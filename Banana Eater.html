<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Banana Eater</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 300 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var player;
    var bananas;
	var bombs;
	var trophy;
    var platforms;
    var cursors;
	var keyboard;
    var score = 100;
    var scoreText;
    var instructions;
	var isOver = false;

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('ground', 'assets/platform.png');
        this.load.image('grenade', 'assets/grenade.png');
        this.load.image('banana', 'assets/banana.png');
		this.load.image('monkey', 'assets/monkey.png');
	    this.load.image('trophy', 'assets/trophy.png');
        this.load.spritesheet('dude', 'assets/sprite1.png', { frameWidth: 36, frameHeight: 34 });
        this.load.spritesheet('explosion', 'assets/explosion0.png', { frameWidth: 128, frameHeight: 128 });
    }

    function create ()
    {
        player = this.physics.add.sprite(300, 450, 'monkey');

		player.setBounceX(0.2);
        player.setBounceY(0.2);
        player.setCollideWorldBounds(true);
        player.body.setGravityY(1000);
        player.body.collideWorldBounds = false;

        cursors = this.input.keyboard.createCursorKeys();
        keyboard = {
            SPACE : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
            A : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
            W : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
            D : this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D)
        }
		

		platforms = this.physics.add.staticGroup();
		bananas = this.physics.add.group();
		bombs = this.physics.add.group();
		trophy = this.physics.add.group();
		platforms.create(300, 568, 'ground').setScale(1.5).refreshBody();
        
        for(let i = 0; i <= 10; i++){
            this.anims.create({
                key: 'mokey'+ i,
                frames: [ { key: 'dude', frame: i } ],
                frameRate: 20
            });
        }
        
        this.anims.create({
                key: 'boom',
                frames: this.anims.generateFrameNumbers('explosion', { start: 0, end:  5}),
                frameRate: 30,
                repeat : 0
        });
        

		let step = 0;
		let length = 100;
		for(let i = 0; i < length; i++){
			let scale = Phaser.Math.Between(50, 90)/100;
			let x = Phaser.Math.Between(-50, 750);
			let y = 400 + step*(-130)+(Phaser.Math.Between(-40, 40));
			var platform = platforms.create(x, y, 'ground').setScale(scale).refreshBody();
			platform.body.checkCollision.down = false;
	        platform.body.checkCollision.left = false;
	        platform.body.checkCollision.right = false;
			if(i == Math.round(length/3) || i == Math.round((length/3)*2) || i == length-1){
				trophy.create(platform.x, platform.y - 50, 'trophy');
               
                step++;
				continue;
			}
            
            

			if(Phaser.Math.Between(0, 100) < 60){
                createBanana(1);
			}
            
            if(Phaser.Math.Between(0, 100) < 50){
                createBomb(1);
			}

			function createBanana(number){
				if(number==3){
                   return 0;
                }
				bananas.create(Phaser.Math.Between(x - (platform.width*scale)/2 + 18, x + (platform.width*scale)/2 - 18), (y - 18-number*30), 'banana');
				if(Phaser.Math.Between(0, Math.round(100*(number*0.6))) < 20){
					createBanana(++number);
				}
			}
            function createBomb(number){
				if(number==3){
                   return 0;
                }
				bombs.create(Phaser.Math.Between(x - (platform.width*scale)/2 + 20, x + (platform.width*scale)/2 - 20), (y - 18-number*30), 'grenade');
				if(Phaser.Math.Between(0, Math.round(100*(number*0.6))) < 25){
					createBanana(++number);
				}
			}
			step++;
		}

        bananas.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.2, 0.3));
        });
        this.cameras.main.startFollow(player);
        
        scoreText = this.add.text(16, 16, 'Height: 0\nFood: 0', { fontSize: '32px', fill: '#eee' });
        instructions = this.add.text(-50, 600, '\nUp arrow - simple jump(cost: 3 points of food)\n'+
                                            'Left or right arrow - move to left or right(cost: 0 points of food)\n'+
                                            'Space button - boosted jump(cost: 25 points of food)\n'+
                                            'Cathing banana: +10 points of food, cathing bomb: -15 points of food\n'+
                                            'If food points are zero - you dead. If you find a trophy - you win',
                                            { fontSize: '18px', fill: '#eee' });
        
		this.cameras.main.startFollow(player);

		this.physics.add.collider(platforms, platforms);
        this.physics.add.collider(player, platforms);
		this.physics.add.collider(bananas, platforms);
		this.physics.add.collider(bombs, platforms);
        this.physics.add.collider(trophy, platforms);
        this.physics.add.collider(bombs, bananas);
		this.physics.add.collider(bananas, bananas);
		this.physics.add.collider(bombs, bombs);
		

        this.physics.add.overlap(player, bananas, collectbanana, null, this);
		this.physics.add.overlap(player, bombs, (player, bomb)=>{
            let boom = this.physics.add.sprite(300, 450, 'monkey');
            boom.x=bomb.x;
            boom.y=bomb.y;
            boom.body.setGravityY(0);
            boom.anims.play('boom', true);
            
            setTimeout(()=>{boom.disableBody(true, true);}, 500);
            collectBomb(player, bomb);
        }, null, this);
		this.physics.add.overlap(player, trophy, collectTrophy, null, this);
    }

    function update ()
    {
		if(isOver == false){
        ///moving
	        let acsekleration = 1000;
	        let maxSpeed = 500;
	        if( cursors.left.isDown || keyboard.A.isDown) {
	            player.body.setGravityX(-acsekleration);
	        } else if( cursors.right.isDown  || keyboard.D.isDown) {
	            player.body.setGravityX(acsekleration);
	        } else {
				if(Math.abs(player.body.velocity.x) < 0.01){
					player.body.velocity.x = 0;
				}
	            if(player.body.velocity.x == 0){
	                player.body.setGravityX(0);
	            }else if(player.body.velocity.x > 0){
	                player.body.setGravityX(-acsekleration);
	            }else{
	                player.body.setGravityX(acsekleration);
	            }
	        }
	        if(Math.abs(player.body.velocity.x) > maxSpeed){
	           player.body.velocity.x = maxSpeed * Math.sign(player.body.velocity.x);
	        }
	        //jumping
	        if (player.body.touching.down && (cursors.up.isDown || keyboard.W.isDown))
	        {
	            player.setVelocityY(-730);
				score -= 3;
	        }else if(keyboard.SPACE.isDown && player.body.touching.down){
				if(score>=25){
					player.setVelocityY(-730*1.8);
					score -= 25;
				}else{
					player.setVelocityY(-730);
					score -= 3;
				}
			}
            if(cursors.left.isDown || cursors.right.isDown || cursors.up.isDown) {
	            instructions.setText('');
	        } 
		}
        
        //fat monkey test
        if(score < 10){
            player.anims.play('mokey0');   
        }else if(score<20){
            player.anims.play('mokey1');
        }else if(score<40){
            player.anims.play('mokey2');
        }else if(score<70){
            player.anims.play('mokey3');
        }else if(score<120){
            player.anims.play('mokey4');
        }else if(score<140){
            player.anims.play('mokey5');
        }else if(score<150){
            player.anims.play('mokey6');
        }else if(score<160){
            player.anims.play('mokey7');
        }else if(score<170){
            player.anims.play('mokey8');
        }else if(score<190){
            player.anims.play('mokey9');
        }else{
            player.anims.play('mokey10');
        }
        
        
		///Link scores to player
		let height, food;
		if(isOver == false){
			scoreText.x = player.x - 395;
			scoreText.y = player.y - 297;
			food = 'Food: ' + score;
			height = 'Height: '+(Math.abs((player.y - 400)/130) + '').split('.')[0];
		}
		if(isOver==false && (player.y - 800 > 0 || score < 0)){
			gameOver();
			if(isOver == false)
				isOver = true;
			scoreText.y = player.y - scoreText.height - 20;
		}
        if(isOver == null){
           gameOver();
           }
		if(player.y - 800 > 0 || score < 0 || isOver == true || isOver == null){
			scoreText.x = player.x - scoreText.width/2;
            if(score < 0){
               height = 'Food is over';
            }else{
               height = 'Monkey dead';
            }
			food = '\n';
			
			if(isOver == null){
				height = 'You Win!';
				food = '\n';
			     scoreText.y = player.y - 150;
			}
			player.setVelocityY(50);
		}
		scoreText.setText(height + '\n' + food);


		function gameOver(){
			platforms.children.iterate(function (platform) {
	            platform.disableBody(true, true);
	        });
			bananas.children.iterate(function (banana) {
	            banana.setVelocityY(250);
				banana.body.setGravityY(0);
	        });
			bombs.children.iterate(function (bomb) {
				bomb.setVelocityY(450);
				bomb.body.setGravityY(0);
	        });
            trophy.children.iterate(function (bomb) {
				bomb.setVelocityY(200);
				bomb.body.setGravityY(0);
	        });
			player.body.setGravityY(0);
			player.body.setGravityX(0);
			player.setVelocityY(0);
			player.setVelocityX(0);

		}
    }

    function collectbanana (player, banana)
    {
        banana.disableBody(true, true);
        if(isOver==false){
            score += 10;
        }
    }

	function collectBomb (player, bomb)
    {
        bomb.disableBody(true, true);
        if(isOver==false){
            score -= 15;
        }
    }

	function collectTrophy (player, trophy)
    {
        trophy.disableBody(true, true);
        if(!isOver){
           isOver = null;
        }
    }

</script>

</body>
</html>
